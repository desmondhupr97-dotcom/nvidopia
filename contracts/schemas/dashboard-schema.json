{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://nvidopia.dev/schemas/dashboard-config/v1",
  "title": "Nvidopia Dashboard-as-Code Configuration",
  "description": "JSON Schema for declarative dashboard definitions. Each dashboard JSON file conforming to this schema can be rendered by the Nvidopia dashboard engine.",
  "type": "object",
  "required": ["dashboard_id", "title", "panels"],
  "properties": {
    "dashboard_id": {
      "type": "string",
      "description": "Unique identifier for this dashboard",
      "pattern": "^[a-z0-9-]+$"
    },
    "title": {
      "type": "string",
      "description": "Human-readable dashboard title"
    },
    "description": {
      "type": "string"
    },
    "global_refresh_rate": {
      "type": "integer",
      "description": "Auto-refresh interval in seconds. 0 disables auto-refresh.",
      "minimum": 0,
      "default": 30
    },
    "templating": {
      "type": "object",
      "description": "Dashboard-level template variables for dynamic filtering",
      "properties": {
        "variables": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TemplateVariable"
          }
        }
      }
    },
    "panels": {
      "type": "array",
      "description": "List of visualization panels in this dashboard",
      "items": {
        "$ref": "#/definitions/Panel"
      },
      "minItems": 1
    }
  },
  "definitions": {
    "TemplateVariable": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Variable name used in queries via ${name} syntax",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
        },
        "type": {
          "type": "string",
          "description": "Variable type determines how values are resolved",
          "enum": ["query", "custom", "constant", "interval"]
        },
        "label": {
          "type": "string",
          "description": "Display label in the dashboard UI"
        },
        "query": {
          "type": "string",
          "description": "Query expression to populate variable options (for type=query)"
        },
        "default": {
          "description": "Default value when no selection is made",
          "oneOf": [
            { "type": "string" },
            { "type": "number" },
            { "type": "boolean" }
          ]
        },
        "options": {
          "type": "array",
          "description": "Static options (for type=custom)",
          "items": {
            "type": "object",
            "properties": {
              "label": { "type": "string" },
              "value": { "type": "string" }
            },
            "required": ["label", "value"]
          }
        },
        "multi": {
          "type": "boolean",
          "description": "Allow multiple selections",
          "default": false
        }
      }
    },
    "Panel": {
      "type": "object",
      "required": ["panel_id", "title", "visualization_type", "grid_position", "data_targets"],
      "properties": {
        "panel_id": {
          "type": "string",
          "description": "Unique panel identifier within the dashboard",
          "pattern": "^[a-z0-9-]+$"
        },
        "title": {
          "type": "string",
          "description": "Panel display title"
        },
        "description": {
          "type": "string"
        },
        "visualization_type": {
          "type": "string",
          "description": "Chart/visualization type",
          "enum": ["timeseries", "gauge", "table", "stat"]
        },
        "grid_position": {
          "$ref": "#/definitions/GridPosition"
        },
        "data_targets": {
          "type": "array",
          "description": "Data source queries powering this panel",
          "items": {
            "$ref": "#/definitions/DataTarget"
          },
          "minItems": 1
        },
        "presentation_options": {
          "$ref": "#/definitions/PresentationOptions"
        }
      }
    },
    "GridPosition": {
      "type": "object",
      "description": "Panel position and size on the dashboard grid",
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": {
          "type": "integer",
          "minimum": 0,
          "description": "Column position (0-based)"
        },
        "y": {
          "type": "integer",
          "minimum": 0,
          "description": "Row position (0-based)"
        },
        "w": {
          "type": "integer",
          "minimum": 1,
          "maximum": 24,
          "description": "Width in grid units"
        },
        "h": {
          "type": "integer",
          "minimum": 1,
          "maximum": 24,
          "description": "Height in grid units"
        }
      }
    },
    "DataTarget": {
      "type": "object",
      "required": ["datasource_type", "metric_query"],
      "properties": {
        "datasource_type": {
          "type": "string",
          "description": "Type of data source backing this target",
          "enum": ["kafka_aggregated_kpi", "mongodb_query"]
        },
        "metric_query": {
          "type": "string",
          "description": "Query expression specific to the datasource type. For kafka_aggregated_kpi: metric name. For mongodb_query: aggregation pipeline expression."
        },
        "legend": {
          "type": "string",
          "description": "Legend label for this data series"
        },
        "ref_id": {
          "type": "string",
          "description": "Reference ID for cross-target expressions"
        },
        "filters": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Key-value filter dimensions applied to the query"
        }
      }
    },
    "PresentationOptions": {
      "type": "object",
      "description": "Visual presentation configuration for the panel",
      "properties": {
        "y_axis_scale": {
          "type": "string",
          "description": "Y-axis scaling mode",
          "enum": ["linear", "log", "sqrt"],
          "default": "linear"
        },
        "y_axis_label": {
          "type": "string"
        },
        "y_axis_min": {
          "type": "number"
        },
        "y_axis_max": {
          "type": "number"
        },
        "color_scheme": {
          "type": "string",
          "description": "Named color palette"
        },
        "decimals": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of decimal places for value display"
        },
        "unit_format": {
          "type": "string",
          "description": "Display unit (km, %, hours, etc.)"
        },
        "alert_thresholds": {
          "$ref": "#/definitions/AlertThresholds"
        }
      }
    },
    "AlertThresholds": {
      "type": "object",
      "description": "Alert threshold configuration for visual indicators",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ThresholdRule"
          }
        }
      }
    },
    "ThresholdRule": {
      "type": "object",
      "required": ["condition", "value", "color"],
      "properties": {
        "condition": {
          "type": "string",
          "description": "Comparison operator",
          "enum": ["gt", "gte", "lt", "lte", "eq"]
        },
        "value": {
          "type": "number",
          "description": "Threshold value"
        },
        "color": {
          "type": "string",
          "description": "Color to apply when condition is met (CSS color or named: green, yellow, orange, red)"
        },
        "label": {
          "type": "string",
          "description": "Human-readable label for this threshold"
        }
      }
    }
  }
}
